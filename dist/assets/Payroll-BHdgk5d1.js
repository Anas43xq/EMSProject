import{a as Q,u as V,s as S,j as e}from"./index-BBL5zgFY.js";import{r as p,d as Z}from"./vendor-5bkAA5gm.js";import{E as ee}from"./pdf-BwXo9bY9.js";import{b as te}from"./notifications-B8UuC0J2.js";import{m as se,D as M,r as ae,X as le}from"./lucide-cejH3fEv.js";import"./supabase-CQnWzhEg.js";function ne(l){const s=new ee,d=s.internal.pageSize.getWidth(),_=s.internal.pageSize.getHeight(),o=15;let a=o;s.setFontSize(20),s.setFont("helvetica","bold"),s.text("PAYSLIP",d/2,a,{align:"center"}),a+=10,s.setFontSize(9),s.setFont("helvetica","normal"),s.text("Employee Management System - University Administration Portal",d/2,a,{align:"center"}),a+=8,s.setDrawColor(100,100,100),s.line(o,a,d-o,a),a+=8,s.setFontSize(11),s.setFont("helvetica","bold"),s.text("EMPLOYEE INFORMATION",o,a),a+=8,s.setFontSize(9),s.setFont("helvetica","normal"),s.text(`Name: ${l.employeeName}`,o,a),s.text(`Employee ID: ${l.employeeId}`,d/2,a),a+=6,s.text(`Position: ${l.position}`,o,a),s.text(`Department: ${l.department}`,d/2,a),a+=6,s.text(`Pay Period: ${l.month} ${l.year}`,o,a),s.text(`Status: ${l.status.charAt(0).toUpperCase()+l.status.slice(1)}`,d/2,a),l.paymentDate&&(a+=6,s.text(`Payment Date: ${l.paymentDate}`,o,a)),a+=12,s.setFont("helvetica","bold"),s.text("SALARY DETAILS",o,a),a+=8,s.setFillColor(41,128,185),s.setTextColor(255,255,255),s.setFontSize(9);const m=o,y=d/2;s.rect(o,a-5,d-2*o,6,"F"),s.text("Description",m+2,a),s.text("Amount",y+2,a),a+=8,s.setTextColor(0,0,0),s.setFont("helvetica","normal"),s.text("Basic Salary",m+2,a),s.text(`$${l.basicSalary.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a),a+=6;const F=Object.values(l.allowances).reduce((g,c)=>g+c,0);F>0&&(s.setFont("helvetica","bold"),s.text("ALLOWANCES",m+2,a),a+=6,s.setFont("helvetica","normal"),Object.entries(l.allowances).forEach(([g,c])=>{const h=g.replace(/_/g," ").toUpperCase();s.text(`  ${h}`,m+4,a),s.text(`$${c.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a),a+=5}),s.setFont("helvetica","bold"),s.text("  Total Allowances",m+4,a),s.text(`$${F.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a)),a+=8;const f=Object.values(l.deductions).reduce((g,c)=>g+c,0);f>0&&(s.setFont("helvetica","bold"),s.text("DEDUCTIONS",m+2,a),a+=6,s.setFont("helvetica","normal"),Object.entries(l.deductions).forEach(([g,c])=>{const h=g.replace(/_/g," ").toUpperCase();s.text(`  ${h}`,m+4,a),s.text(`$${c.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a),a+=5}),s.setFont("helvetica","bold"),s.text("  Total Deductions",m+4,a),s.text(`$${f.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a)),a+=12,s.setFillColor(240,240,240),s.rect(o,a-5,d-2*o,18,"F"),s.setFontSize(10),s.setFont("helvetica","bold"),s.text("GROSS SALARY",m+2,a),s.text(`$${l.grossSalary.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a),a+=7,s.text("TOTAL DEDUCTIONS",m+2,a),s.text(`$${f.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a),a+=7,s.setFillColor(41,128,185),s.setTextColor(255,255,255),s.text("NET SALARY",m+2,a),s.text(`$${l.netSalary.toLocaleString("en-US",{maximumFractionDigits:2})}`,y+2,a),a=_-25,s.setDrawColor(100,100,100),s.line(o,a,d-o,a),a+=8,s.setTextColor(0,0,0),s.setFontSize(8),s.setFont("helvetica","normal"),s.text("This is an automated payslip. No signature required.",d/2,a,{align:"center"}),a+=4,s.text(`Generated on: ${new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}`,d/2,a,{align:"center"});const j=`Payslip_${l.employeeName.replace(/\s+/g,"_")}_${l.month}_${l.year}.pdf`;s.save(j)}const D=["January","February","March","April","May","June","July","August","September","October","November","December"];function xe(){const[l,s]=p.useState([]),[d,_]=p.useState(!0),[o,a]=p.useState(!1),[m,y]=p.useState(null),[F,f]=p.useState(!1),[j,g]=p.useState([]),[c,h]=p.useState([]),[L,k]=p.useState(!1),[P,Y]=p.useState(new Date().getMonth()+1),[C,I]=p.useState(new Date().getFullYear()),{user:r}=Q(),{showNotification:N}=V(),[$,G]=p.useState(new Date().getFullYear());p.useEffect(()=>{O()},[r,$]);const O=async()=>{try{let t=S.from("payroll").select(`
          *,
          employees (
            first_name,
            last_name,
            employee_number,
            position,
            departments (
              name
            )
          )
        `).eq("year",$).order("month",{ascending:!1});(r==null?void 0:r.role)==="employee"&&(r!=null&&r.employeeId)&&(t=t.eq("employee_id",r.employeeId));const{data:n,error:i}=await t;if(i)throw i;s(n||[])}catch(t){console.error("Error loading payroll:",t),N("error","Failed to load payroll records")}finally{_(!1)}},z=t=>{var n,i,x,u,b,v;try{const w={employeeName:`${(n=t.employees)==null?void 0:n.first_name} ${(i=t.employees)==null?void 0:i.last_name}`,employeeId:((x=t.employees)==null?void 0:x.employee_number)||"N/A",position:((u=t.employees)==null?void 0:u.position)||"N/A",department:((v=(b=t.employees)==null?void 0:b.departments)==null?void 0:v.name)||"N/A",month:D[t.month-1],year:t.year,basicSalary:t.basic_salary,allowances:t.allowances||{},deductions:t.deductions||{},grossSalary:t.gross_salary,netSalary:t.net_salary,status:t.status,paymentDate:t.payment_date?new Date(t.payment_date).toLocaleDateString():void 0};ne(w),N("success","Payslip downloaded successfully")}catch(w){console.error("Error downloading payslip:",w),N("error","Failed to download payslip")}},R=async()=>{if(l.length===0){N("warning","No payroll records to notify");return}a(!0);try{let t=0;for(const n of l)try{await te("employee@university.edu",D[n.month-1],n.year,n.net_salary),t++}catch(i){console.error(`Failed to notify for record ${n.id}:`,i)}N("success",`Payroll notifications sent to ${t} employees`)}finally{a(!1)}},q=async()=>{try{const{data:t,error:n}=await S.from("employees").select(`
          id,
          first_name,
          last_name,
          position,
          employment_type,
          departments (name)
        `).eq("status","active").order("last_name");if(n)throw n;g(t||[])}catch(t){console.error("Error loading employees:",t),N("error","Failed to load employees")}},H=async()=>{if(c.length===0){N("warning","Please select at least one employee");return}k(!0);try{let t=0,n=0;for(const i of c)try{const{data:x}=await S.from("payroll").select("id").eq("employee_id",i).eq("month",P).eq("year",C).single();if(x){n++;continue}const{data:u}=await S.from("employees").select("id, salary").eq("id",i).single();if(!u)continue;const b=u.salary||0,v={hra:b*.1,da:b*.08},w={pf:b*.12,tax:b*.05},B=Object.values(v).reduce((A,E)=>A+E,0),X=Object.values(w).reduce((A,E)=>A+E,0),T=b+B,K=T-X,{error:U}=await S.from("payroll").insert({employee_id:i,month:P,year:C,basic_salary:b,allowances:v,deductions:w,gross_salary:T,net_salary:K,status:"pending"});if(U)throw U;t++}catch(x){console.error(`Error generating payroll for employee ${i}:`,x)}N("success",`Payroll generated for ${t} employees${n>0?` (${n} already exist)`:""}`),f(!1),h([]),O()}finally{k(!1)}},J=t=>{h(n=>n.includes(t)?n.filter(i=>i!==t):[...n,t])},W=()=>{c.length===j.length?h([]):h(j.map(t=>t.id))};return d?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Payroll"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Manage salary and payslips"})]}),e.jsx("div",{className:"flex items-center space-x-3",children:((r==null?void 0:r.role)==="admin"||(r==null?void 0:r.role)==="hr")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:R,disabled:o||l.length===0,className:"flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Notifying..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-5 h-5"}),e.jsx("span",{children:"Notify All"})]})}),e.jsxs("button",{onClick:()=>{q(),f(!0)},className:"flex items-center space-x-2 bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition-colors",children:[e.jsx(M,{className:"w-5 h-5"}),e.jsx("span",{children:"Generate Payroll"})]})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-4 mb-6",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Year:"}),e.jsx("select",{value:$,onChange:t=>G(Number(t.target.value)),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[2024,2025,2026].map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[(r==null?void 0:r.role)!=="employee"&&e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Month"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Basic Salary"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Gross Salary"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Net Salary"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:l.map(t=>{var n,i;return e.jsxs(Z.Fragment,{children:[e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>y(m===t.id?null:t.id),children:[(r==null?void 0:r.role)!=="employee"&&e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[(n=t.employees)==null?void 0:n.first_name," ",(i=t.employees)==null?void 0:i.last_name]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:D[t.month-1]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm text-gray-900",children:["$",t.basic_salary.toLocaleString()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm text-gray-900",children:["$",t.gross_salary.toLocaleString()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["$",t.net_salary.toLocaleString()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${t.status==="paid"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("button",{onClick:x=>{x.stopPropagation(),z(t)},className:"flex items-center space-x-1 text-blue-600 hover:text-blue-900 font-medium transition-colors",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Download"})]})})]}),m===t.id&&e.jsx("tr",{className:"bg-blue-50",children:e.jsx("td",{colSpan:(r==null?void 0:r.role)==="employee"?6:7,className:"px-6 py-4",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[Object.keys(t.allowances||{}).length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Allowances"}),e.jsx("div",{className:"space-y-2",children:Object.entries(t.allowances||{}).map(([x,u])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:x.replace(/_/g," ").toUpperCase()}),e.jsxs("span",{className:"font-medium text-gray-900",children:["$",u.toLocaleString()]})]},x))})]}),Object.keys(t.deductions||{}).length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Deductions"}),e.jsx("div",{className:"space-y-2",children:Object.entries(t.deductions||{}).map(([x,u])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:x.replace(/_/g," ").toUpperCase()}),e.jsxs("span",{className:"font-medium text-red-600",children:["-$",u.toLocaleString()]})]},x))})]})]})})})})]},t.id)})})]})}),l.length===0&&e.jsx("div",{className:"text-center py-12",children:e.jsxs("p",{className:"text-gray-500",children:["No payroll records found for ",$]})})]}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-96",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Generate Payroll"}),e.jsx("button",{onClick:()=>{f(!1),h([])},className:"text-gray-400 hover:text-gray-600",children:e.jsx(le,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-6 space-y-4 overflow-y-auto",style:{maxHeight:"400px"},children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Month"}),e.jsx("select",{value:P,onChange:t=>Y(Number(t.target.value)),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:D.map((t,n)=>e.jsx("option",{value:n+1,children:t},n))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("select",{value:C,onChange:t=>I(Number(t.target.value)),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[2024,2025,2026].map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Employees"}),e.jsx("button",{onClick:W,className:"text-xs text-blue-600 hover:text-blue-900 font-medium",children:c.length===j.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"border border-gray-300 rounded-lg divide-y max-h-48 overflow-y-auto",children:j.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No active employees found"}):j.map(t=>e.jsxs("label",{className:"flex items-center p-3 hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:c.includes(t.id),onChange:()=>J(t.id),className:"rounded text-blue-900 focus:ring-blue-500"}),e.jsxs("span",{className:"ml-3 text-sm text-gray-900",children:[t.first_name," ",t.last_name,e.jsxs("span",{className:"text-gray-500 text-xs ml-2",children:["(",t.position,")"]})]})]},t.id))}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Selected: ",c.length," / ",j.length]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-blue-800",children:"ℹ️ Payroll will be generated with calculated allowances (HRA 10%, DA 8%) and deductions (PF 12%, Tax 5%)."})})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 p-6 border-t border-gray-200",children:[e.jsx("button",{onClick:()=>{f(!1),h([])},className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:H,disabled:L||c.length===0,className:"flex items-center space-x-2 px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:L?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate Payroll"})]})})]})]})})]})}export{xe as default};
